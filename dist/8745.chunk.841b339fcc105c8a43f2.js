"use strict";(self.webpackChunkng_universal_demo=self.webpackChunkng_universal_demo||[]).push([[8745],{18745:(t,e,i)=>{i.d(e,{F:()=>U});var n=i(79077),o=i(8530),s=i(94060),a=i(28232),r=i(23199),h=i(86463),d=i(40362);class c{get destroying(){return this.destroyingSubject.asObservable()}constructor(t,e,i,n,o){this.parentGroup=t,this.relationManager=e,this.history=i,this.start=n,this.end=o,this.destroyingSubject=new h.x,this.output=null,this.input=null,this.path=this.parentGroup.append("path").attr("fill","transparent").attr("stroke","#48B8B8").attr("stroke-width","3px").on("mouseover",(()=>{this.highlight()})).on("mouseout",(()=>{this.cancelHighlight()})),this.lineGenerator=(0,a.jvg)().curve(a.tFB.beta(.75))}destroy(){this.path?.remove(),this.destroyingSubject.next()}highlight(){this.path.attr("stroke-width","5px"),this.input?.highlight(),this.output?.highlight()}cancelHighlight(){this.path.attr("stroke-width","3px"),this.input?.cancelHighlight(),this.output?.cancelHighlight()}invalidateVisuals(t){if(t==d.r){const t=this.relationManager.getActiveInput();this.relationManager.setActiveInput(null),t?t.addRelation(this)?(this.end=t.getCoordinates(),this.input=t,this.history.getNewState()):(this.destroy(),this.start=null,this.end=null,this.input=null,this.output=null,this.history.getNewState()):(this.destroy(),this.start=null,this.end=null,this.input=null,this.output=null)}if(!this.start||!this.end)return;let e;if(this.end.x<=this.start.x){let t=this.start.x-this.end.x;const i=(this.end.y-this.start.y)/10;t<12&&(t=12),t*=1.3,e=[[this.start.x,this.start.y],[this.start.x+40,this.start.y],[this.start.x+t,this.start.y+i],[this.end.x-t,this.start.y+9*i],[this.end.x-40,this.end.y],[this.end.x,this.end.y]]}else{const t=(this.end.x-this.start.x)/3;e=[[this.start.x,this.start.y],[this.start.x+t,this.start.y],[this.end.x-t,this.end.y],[this.end.x,this.end.y]]}this.path.attr("d",this.lineGenerator(e))}}var l,u=i(26220),g=i(47432),m=i(80607),v=i(26038),p=i(7199),y=i(91861);!function(t){t[t.ShowNotFound=0]="ShowNotFound",t[t.Ignore=1]="Ignore",t[t.ThrowError=2]="ThrowError"}(l||(l={}));class x{constructor(t){this.missingNodeBehavior=l.ShowNotFound,(0,p.EN)(t)&&(this.missingNodeBehavior=t)}}var f=i(15554),b=i(81874),w=i(5549),M=i(28539),N=i(48397);function P(t,e,i,n,o,s,a){try{var r=t[s](a),h=r.value}catch(t){return void i(t)}r.done?e(h):Promise.resolve(h).then(n,o)}class S{get component(){return this.componentRef?this.componentRef.instance:null}constructor(t,e,i,o,s){this.viewContainerRef=t,this.relationsNodeManager=e,this.loader=i,this.options=o,this.logger=s,this.destroySubscription=null,this.componentRef=null,this.componentMetadata=null,this.zoomLevel=1,this.create=new n.v,this.destroy=new n.v,this.options&&this.options instanceof x||(this.options=new x)}ngOnChanges(t){var e,i=this;return(e=function*(){if((0,p.$0)("zoomLevel")in t&&(0,p.EN)(i.zoomLevel)&&!((0,p.$0)("componentMetadata")in t)){const e=i.component;if(e){const n=t[(0,p.$0)("zoomLevel")];e.zoomLevel=i.zoomLevel;const o={};(0,v.mv)(o,"zoomLevel",n,n.previousValue),e.ngOnChanges(o),e.invalidateVisuals()}}else if(i.logger?.debug("RelationsNodeRendererSADirective: rendering node {{@id}}",{id:i.componentMetadata?.id}),i.ngOnDestroy(),i.viewContainerRef.clear(),(0,p.$0)("componentMetadata")in t&&i.componentMetadata){let t=yield i.loader.loadItem(i.componentMetadata);if(!t)switch(i.logger?.warn("RelationsNodeRendererSADirective: Unable to find relations node type {{@type}}",{type:{name:i.componentMetadata.name,package:i.componentMetadata.package}}),i.options?.missingNodeBehavior){default:if(t=yield i.loader.loadItem({package:"basic-components",name:"notFound"}),!t)return void i.logger?.error("RelationsNodeRendererSADirective: Unable to find not found node!");break;case l.Ignore:return;case l.ThrowError:throw new Error(`RelationsNodeRendererSADirective: Unable to find relations node type Name: ${i.componentMetadata.name} Package: ${i.componentMetadata.package}`)}if(i.componentRef=i.viewContainerRef.createComponent(t.data,{injector:i.viewContainerRef.injector}),i.logger?.debug("RelationsNodeRendererSADirective: node rendered {{@id}}",{id:i.componentMetadata?.id}),i.component){const t=i.component;i.destroySubscription=t.destroy.subscribe((()=>i.ngOnDestroy())),i.logger?.debug("RelationsNodeRendererSADirective: initializing node with metadata {{@id}}",{id:i.componentMetadata?.id}),t.metadata=i.componentMetadata,t.zoomLevel=i.zoomLevel;const e={};(0,v.mv)(e,"metadata",i.componentMetadata,null,!0),(0,v.mv)(e,"zoomLevel",i.zoomLevel,null,!0),t.ngOnChanges(e),yield t.initialize(),i.logger?.debug("RelationsNodeRendererSADirective: invalidating node visuals {{@id}}",{id:i.componentMetadata?.id}),t.invalidateVisuals(),i.componentRef.changeDetectorRef.markForCheck(),i.relationsNodeManager.registerNode(i.component),i.create.next(t)}}},function(){var t=this,i=arguments;return new Promise((function(n,o){var s=e.apply(t,i);function a(t){P(s,n,o,a,r,"next",t)}function r(t){P(s,n,o,a,r,"throw",t)}a(void 0)}))})()}ngOnDestroy(){this.destroySubscription?.unsubscribe(),this.destroySubscription=null,this.componentRef&&(this.logger?.debug("RelationsNodeRendererSADirective: destroying node {{@id}}",{id:this.componentMetadata?.id}),this.component&&(this.componentMetadata&&this.destroy.next(this.componentMetadata),this.relationsNodeManager.unregisterNode(this.component)),this.componentRef?.destroy(),this.componentRef=null)}}S.ɵfac=function(t){return new(t||S)(f.Y(b.s_),f.Y(N.J),f.Y(y.fI),f.Y(x,8),f.Y(m.bZ,8))},S.ɵdir=w.lG({type:S,selectors:[["","relationsNodeRenderer",""]],inputs:{componentMetadata:["relationsNodeRenderer","componentMetadata"],zoomLevel:"zoomLevel"},outputs:{create:"create",destroy:"destroy"},exportAs:["relationsNodeRenderer"],standalone:!0,features:[M.T]});var z=i(97710),L=i(71325),R=i(12142),B=i(45473),D=i(84746),k=i(55640),_=i(31246),C=i(86870),Y=i(11845),T=i(75151),O=i(12931),F=i(83052),I=i(94353),Z=i(41820),E=i(60054);const A=["relationsGroup"];function G(t,e){if(1&t){const t=z.E();L.O4(),L.kc(),R.yn(0)(1,4),B.N("destroy",(function(e){L.CH(t);const i=D.o();return L.Kt(i.destroyNode(e))})),R.BQ()()}if(2&t){const t=e.$implicit,i=D.o();k.x(1),_.Q("relationsNodeRenderer",t)("zoomLevel",i.zoomLevel)}}const $=10;class U{get backgroundSizeStyle(){return`${this.backgroundSize}px ${this.backgroundSize}px`}get _backgroundPositionStyle(){return`${this.canvasPosition.x%this.backgroundSize}px ${this.canvasPosition.y%this.backgroundSize}px`}get boundingBox(){return this.element.nativeElement.getBoundingClientRect()}constructor(t,e,i,o){this.element=t,this.relationManager=e,this._changeDetector=i,this.history=o,this._canvasMoveTimer=null,this._initSubscriptions=new r.w0,this.backgroundSize=16,this.dragStartPosition={x:0,y:0},this.canvasPosition={x:0,y:0},this.mousePosition={x:0,y:0},this.zoomLevel=1,this.isDragging=!1,this.nodeDefinitions=[],this.convasPositionChanged=new n.v}ngOnInit(){this._initSubscriptions.add(this.relationManager.activeNodeChange.subscribe((()=>this.focusNode(this.relationManager.activeNode))))}ngOnDestroy(){this._initSubscriptions.unsubscribe()}focusNode(t){if(!t)return;const e=this.nodeDefinitions?.find((e=>e.id===t));e?.nodeMetadata?.coordinates&&(this.canvasPosition={x:-e?.nodeMetadata?.coordinates.x*this.zoomLevel+this.boundingBox.width/2,y:-e?.nodeMetadata?.coordinates.y*this.zoomLevel+this.boundingBox.height/2},this._changeDetector.detectChanges())}createRelation(){return new c((0,a.Ys)(this.relationsGroup?.nativeElement),this.relationManager,this.history,null,null)}getPositionInCanvas(t){return{x:(t.x-this.boundingBox.left-this.canvasPosition.x)/this.zoomLevel,y:(t.y-this.boundingBox.top-this.canvasPosition.y)/this.zoomLevel}}onMouseDown(t){t.buttons==u.t.LEFT&&(this.dragStartPosition={x:t.clientX-this.canvasPosition.x,y:t.clientY-this.canvasPosition.y},this.isDragging=!0)}onMouseMove(t){this.mousePosition={x:t.clientX-this.boundingBox.left,y:t.clientY-this.boundingBox.top},this.isDragging?this.canvasPosition={x:t.clientX-this.dragStartPosition.x,y:t.clientY-this.dragStartPosition.y}:t?.buttons===u.t.LEFT&&(this._canvasMoveTimer||(this._canvasMoveTimer=setInterval((()=>{const t={x:0,y:0};this.mousePosition.x>=.9*this.boundingBox.width?t.x-=Math.min((this.mousePosition.x-.9*this.boundingBox.width)/(this.boundingBox.width/10)*$,$):this.mousePosition.x<=this.boundingBox.width/10&&(t.x+=Math.min((this.boundingBox.width/10-this.mousePosition.x)/(this.boundingBox.width/10)*$,$)),this.mousePosition.y>=.9*this.boundingBox.height?t.y-=Math.min((this.mousePosition.y-.9*this.boundingBox.height)/(this.boundingBox.height/10)*$,$):this.mousePosition.y<=this.boundingBox.height/10&&(t.y+=Math.min((this.boundingBox.height/10-this.mousePosition.y)/(this.boundingBox.height/10)*$,$)),0==t.x&&0==t.y||(this.convasPositionChanged.emit(),this.canvasPosition.x+=t.x,this.canvasPosition.y+=t.y,this._changeDetector.detectChanges())}),33)))}onMouseUp(t){this.isDragging&&(this.isDragging=!1),this._canvasMoveTimer&&(clearInterval(this._canvasMoveTimer),this._canvasMoveTimer=null)}onWheel(t){if(t.deltaY){const e=this._calculateNewZoomLevel(t.deltaY>1?-1:1),i=(t.clientX-this.canvasPosition.x-this.boundingBox.left)/this.zoomLevel,n=(t.clientY-this.canvasPosition.y-this.boundingBox.top)/this.zoomLevel;this.canvasPosition.x=t.clientX-this.boundingBox.left-i*e,this.canvasPosition.y=t.clientY-this.boundingBox.top-n*e,this._setZoomLevel(e)}t.preventDefault(),t.stopImmediatePropagation()}zoomIn(){this._setZoomLevel(this._calculateNewZoomLevel(1))}zoomOut(){this._setZoomLevel(this._calculateNewZoomLevel(-1))}resetZoom(){this._setZoomLevel(1)}destroyNode(t){const e=this.nodeDefinitions.indexOf(t);e<0||(this.nodeDefinitions.splice(e,1),this.history.getNewState())}_calculateNewZoomLevel(t){return(0,g.uZ)(this.zoomLevel+.05*t,.2,2)}_setZoomLevel(t){this.zoomLevel=t,this.backgroundSize=16*this.zoomLevel}}U.ɵfac=function(t){return new(t||U)(f.Y(o.SB),f.Y(N.J),f.Y(C.s),f.Y(y.nR))},U.ɵcmp=w.Xp({type:U,selectors:[["relations-canvas"]],viewQuery:function(t,e){if(1&t&&Y.Gf(A,5,o.SB),2&t){let t;Y.iG(t=Y.CR())&&(e.relationsGroup=t.first)}},hostVars:4,hostBindings:function(t,e){1&t&&B.N("mousedown",(function(t){return e.onMouseDown(t)}))("mousemove",(function(t){return e.onMouseMove(t)}))("mouseup",(function(t){return e.onMouseUp(t)}),!1,T.Jf)("wheel",(function(t){return e.onWheel(t)})),2&t&&O.Ud("background-size",e.backgroundSizeStyle)("background-position",e._backgroundPositionStyle)},inputs:{nodeDefinitions:"nodeDefinitions"},outputs:{convasPositionChanged:"convasPositionChanged"},standalone:!0,features:[F.j],decls:5,vars:3,consts:[[1,"flow-area"],[1,"relations-wrapper"],["relationsGroup",""],[4,"ngFor","ngForOf"],[3,"relationsNodeRenderer","zoomLevel","destroy"]],template:function(t,e){1&t&&(I.Tg(0,"div",0),L.O4(),I.Tg(1,"svg",1),I._U(2,"g",null,2),I.qZ(),Z.Y(4,G,2,2,"ng-container",3),I.qZ()),2&t&&(O.Ud("transform","translate("+e.canvasPosition.x+"px, "+e.canvasPosition.y+"px) scale("+e.zoomLevel+")"),k.x(4),_.Q("ngForOf",e.nodeDefinitions))},dependencies:[s.e,E.sg,S],encapsulation:2,changeDetection:0})},40362:(t,e,i)=>{i.d(e,{r:()=>n});const n="drop"},26220:(t,e,i)=>{var n;i.d(e,{t:()=>n}),function(t){t[t.LEFT=1]="LEFT"}(n||(n={}))}}]);
//# sourceMappingURL=8745.chunk.841b339fcc105c8a43f2.js.map